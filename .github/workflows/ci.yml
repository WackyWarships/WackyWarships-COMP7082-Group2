name: CI - Build and Test

on:
  push:
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'shared/**'
      - 'package*.json'
      - '.github/workflows/**'
  pull_request:
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'shared/**'
      - 'package*.json'
      - '.github/workflows/**'

jobs:
  verify-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Verify workspace structure
      run: |
        echo "Verifying workspace structure..."
        ls -la
        echo "Frontend workspace:"
        ls -la frontend/
        echo "Backend workspace:"
        ls -la backend/
        echo "Shared workspace:"
        ls -la shared/
    
    - name: Check TypeScript compilation (frontend)
      run: |
        echo "Checking frontend TypeScript compilation..."
        cd frontend && npx tsc --noEmit
    
    - name: Check TypeScript compilation (backend)
      run: |
        echo "Checking backend TypeScript compilation..."
        cd backend && npx tsc --noEmit
    
    - name: Build frontend only
      run: |
        echo "Building frontend..."
        npm --workspace frontend run build
        echo "Frontend build completed ✅"
    
    - name: Build backend only
      run: |
        echo "Building backend..."
        npm --workspace backend run build
        echo "Backend build completed ✅"
    
    - name: Test full build command
      run: |
        echo "Testing full build command..."
        npm run build
        echo "Full build completed ✅"
    
    - name: Verify build outputs
      run: |
        echo "Verifying build outputs..."
        echo "Frontend dist contents:"
        ls -la frontend/dist/
        echo "Backend dist contents:"
        ls -la backend/dist/
        
        # Check if essential files exist
        test -f frontend/dist/index.html && echo "✅ Frontend index.html exists"
        test -f backend/dist/backend/src/index.js && echo "✅ Backend index.js exists"